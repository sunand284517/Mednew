<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - MedAssist Now</title>
    <link rel="stylesheet" href="../styles/dashboard-modern.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body data-required-role="admin">
    <script src="../js/config.js"></script>
    <script>
        (async function() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.replace('login.html'); return; }
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { localStorage.clear(); window.location.replace('login.html'); return; }
                const data = await response.json();
                if (data.data.user.role !== 'admin') { alert('Access denied. Admin role required.'); localStorage.clear(); window.location.replace('login.html'); return; }
                localStorage.setItem('userCache', JSON.stringify(data.data.user));
            } catch (e) { console.error('Auth error:', e); localStorage.clear(); window.location.replace('login.html'); }
        })();
    </script>
    <div class="emergency-banner">
        <div class="container">
            <div class="banner-content">
                <i class="fas fa-ambulance"></i>
                <span>Need medicines urgently? We're available 24/7 for emergency deliveries!</span>
                <a href="../user/search.html" class="emergency-btn">Emergency Request</a>
            </div>
        </div>
    </div>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="header-content">
                <div class="user-welcome">
                    <h1><i class="fas fa-chart-line"></i> Analytics</h1>
                    <p>Platform performance and insights</p>
                </div>
                <div class="header-actions">
                    <a href="dashboard.html" class="icon-btn"><i class="fas fa-home"></i></a>
                    <a href="settings.html" class="profile-btn"><i class="fas fa-cog"></i></a>
                </div>
            </div>
        </div>
        <div class="dashboard-content">
            <!-- Time Range Filter -->
            <div style="margin-bottom: 25px;">
                <p style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Time Range:</p>
                <div class="time-range-filter">
                    <button class="time-btn" data-range="7days">Last 7 Days</button>
                    <button class="time-btn" data-range="30days">Last 30 Days</button>
                    <button class="time-btn" data-range="90days">Last 90 Days</button>
                    <button class="time-btn" data-range="all">All Time</button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="medicines-tab"><i class="fas fa-pills"></i> Top Medicines</button>
                <button class="tab-btn" data-tab="pharmacy-tab"><i class="fas fa-store"></i> Top Pharmacies</button>
                <button class="tab-btn" data-tab="delivery-tab"><i class="fas fa-motorcycle"></i> Top Delivery Partners</button>
                <button class="tab-btn" data-tab="inventory-tab"><i class="fas fa-boxes"></i> Medicine Inventory</button>
            </div>

            <!-- Top Medicines Tab -->
            <div id="medicines-tab" class="tab-content active section-card">
                <h2 class="section-title"><i class="fas fa-pills"></i> Best Selling Medicines</h2>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Ranked by total quantity sold in the selected period</p>
                <div id="topMedicinesContainer">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i>
                    </div>
                </div>
            </div>

            <!-- Top Pharmacies Tab -->
            <div id="pharmacy-tab" class="tab-content section-card">
                <h2 class="section-title"><i class="fas fa-store"></i> Top Pharmacies by Orders</h2>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Pharmacies ranked by total orders and revenue generated</p>
                <div id="pharmacyAnalyticsContainer">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i>
                    </div>
                </div>
            </div>

            <!-- Delivery Partners Tab -->
            <div id="delivery-tab" class="tab-content section-card">
                <h2 class="section-title"><i class="fas fa-motorcycle"></i> Top Delivery Partners</h2>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Partners ranked by total deliveries and success rate</p>
                <div id="deliveryAnalyticsContainer">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i>
                    </div>
                </div>
            </div>

            <!-- Medicine Inventory Tab -->
            <div id="inventory-tab" class="tab-content section-card">
                <h2 class="section-title"><i class="fas fa-boxes"></i> Medicine Stock & Availability</h2>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 15px;">Overview of medicine inventory across all pharmacies</p>
                <div id="medicineInventoryContainer">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/analytics.service.js"></script>
    <style>
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #0891b2;
        }

        .tab-btn.active {
            color: #0891b2;
            border-bottom-color: #0891b2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid var(--gradient-primary);
        }

        .ranking-item.rank-2 {
            border-left-color: #d1d5db;
        }

        .ranking-item.rank-3 {
            border-left-color: #cd7f32;
        }

        .ranking-rank {
            min-width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }

        .ranking-item.rank-2 .ranking-rank {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
        }

        .ranking-item.rank-3 .ranking-rank {
            background: linear-gradient(135deg, #cd7f32 0%, #a67c52 100%);
        }

        .ranking-content {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .ranking-stat {
            font-size: 13px;
            color: #64748b;
            display: flex;
            gap: 15px;
        }

        .ranking-value {
            text-align: right;
            min-width: 100px;
        }

        .ranking-value-main {
            font-weight: 700;
            color: #10b981;
            font-size: 18px;
        }

        .ranking-value-sub {
            font-size: 12px;
            color: #64748b;
        }

        .time-range-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .time-btn:hover {
            background: #e2e8f0;
        }

        .time-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .metric-pair {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .metric-pair:last-child {
            border-bottom: none;
        }

        .metric-label {
            flex: 1;
            color: #64748b;
            font-size: 14px;
        }

        .metric-value {
            font-weight: 700;
            color: #0891b2;
            font-size: 18px;
            min-width: 120px;
            text-align: right;
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        let analyticsTimeRange = '30days';

        document.addEventListener('DOMContentLoaded', async function() {
            setupTabNavigation();
            await loadAllAnalytics();
            setupTimeRangeFilters();
        });

        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Remove active class from all
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Show first tab by default
            if (tabButtons.length > 0) {
                tabButtons[0].click();
            }
        }

        function setupTimeRangeFilters() {
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    // Remove active from all
                    timeButtons.forEach(b => b.classList.remove('active'));
                    // Add active to clicked
                    btn.classList.add('active');
                    
                    analyticsTimeRange = btn.getAttribute('data-range');
                    await loadAllAnalytics();
                });
            });

            // Set first as active
            if (timeButtons.length > 0) {
                timeButtons[0].classList.add('active');
            }
        }

        async function loadAllAnalytics() {
            await Promise.all([
                loadTopMedicines(),
                loadPharmacyAnalytics(),
                loadDeliveryAnalytics(),
                loadMedicineInventory()
            ]);
        }

        async function loadTopMedicines() {
            const container = document.getElementById('topMedicinesContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i></div>';
            
            try {
                const medicines = await analyticsService.getTopMedicines(analyticsTimeRange, 10);
                
                if (medicines.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-pills" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>No medicine sales data yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <ul class="ranking-list">
                        ${medicines.map((med, idx) => `
                            <li class="ranking-item rank-${idx + 1}">
                                <div class="ranking-rank">${idx + 1}</div>
                                <div class="ranking-content">
                                    <div class="ranking-name">${med.medicineName}</div>
                                    <div class="ranking-stat">
                                        <span>üì¶ ${med.totalQuantity} sold</span>
                                        <span>üìã ${med.orderCount} orders</span>
                                    </div>
                                </div>
                                <div class="ranking-value">
                                    <div class="ranking-value-main">${formatCurrency(med.totalRevenue)}</div>
                                    <div class="ranking-value-sub">‚Çπ${med.avgPrice}/unit</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading medicines:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error loading data</p>';
            }
        }

        async function loadPharmacyAnalytics() {
            const container = document.getElementById('pharmacyAnalyticsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i></div>';
            
            try {
                const pharmacies = await analyticsService.getPharmacyAnalytics(analyticsTimeRange, 10);
                
                if (pharmacies.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-store" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>No pharmacy data yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <ul class="ranking-list">
                        ${pharmacies.map((pharmacy, idx) => `
                            <li class="ranking-item rank-${idx + 1}">
                                <div class="ranking-rank">${idx + 1}</div>
                                <div class="ranking-content">
                                    <div class="ranking-name">${pharmacy.pharmacyName}</div>
                                    <div class="ranking-stat">
                                        <span>üì¶ ${pharmacy.totalOrders} orders</span>
                                        <span>‚≠ê ${pharmacy.avgRating || 'N/A'} rating</span>
                                    </div>
                                </div>
                                <div class="ranking-value">
                                    <div class="ranking-value-main">${formatCurrency(pharmacy.totalRevenue)}</div>
                                    <div class="ranking-value-sub">Avg: ${formatCurrency(pharmacy.avgOrderValue)}</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading pharmacies:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error loading data</p>';
            }
        }

        async function loadDeliveryAnalytics() {
            const container = document.getElementById('deliveryAnalyticsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i></div>';
            
            try {
                const partners = await analyticsService.getDeliveryPartnerAnalytics(analyticsTimeRange, 10);
                
                if (partners.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-motorcycle" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>No delivery partner data yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <ul class="ranking-list">
                        ${partners.map((partner, idx) => `
                            <li class="ranking-item rank-${idx + 1}">
                                <div class="ranking-rank">${idx + 1}</div>
                                <div class="ranking-content">
                                    <div class="ranking-name">${partner.partnerName}</div>
                                    <div class="ranking-stat">
                                        <span>üöö ${partner.totalDeliveries} deliveries</span>
                                        <span>‚úÖ ${partner.completedDeliveries} completed (${partner.successRate}%)</span>
                                    </div>
                                </div>
                                <div class="ranking-value">
                                    <div class="ranking-value-main">${formatCurrency(partner.totalEarnings)}</div>
                                    <div class="ranking-value-sub">‚≠ê ${partner.avgRating || 'N/A'}</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading delivery partners:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error loading data</p>';
            }
        }

        async function loadMedicineInventory() {
            const container = document.getElementById('medicineInventoryContainer');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 24px; color: #0891b2;"></i></div>';
            
            try {
                const inventory = await analyticsService.getMedicineInventoryAnalytics(15);
                
                if (inventory.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-boxes" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px;"></i>
                            <p>No inventory data yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div>
                        ${inventory.map(item => `
                            <div style="padding: 15px; background: #f8fafc; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid ${item.status === 'Critical' ? '#ef4444' : '#10b981'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${item.medicineName}</div>
                                        <div style="font-size: 13px; color: #64748b;">
                                            In ${item.pharmacyCount} pharmacies ‚Ä¢ Stock: ${item.totalStockAcrossPharma} units
                                        </div>
                                    </div>
                                    <span class="badge badge-${item.status === 'Critical' ? 'danger' : 'success'}">${item.status}</span>
                                </div>
                                <div class="metric-pair" style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px;">
                                    <span class="metric-label">Price Range</span>
                                    <span class="metric-value">${item.priceRange}</span>
                                </div>
                                <div class="metric-pair" style="padding: 8px 0; border-bottom: none;">
                                    <span class="metric-label">Avg Price</span>
                                    <span class="metric-value">‚Çπ${item.avgPrice}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading inventory:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 20px; text-align: center;">Error loading data</p>';
            }
        }

        function formatCurrency(amount) {
            if (!amount) return '‚Çπ0';
            if (amount >= 10000000) return '‚Çπ' + (amount / 10000000).toFixed(1) + 'Cr';
            if (amount >= 100000) return '‚Çπ' + (amount / 100000).toFixed(1) + 'L';
            if (amount >= 1000) return '‚Çπ' + (amount / 1000).toFixed(1) + 'K';
            return '‚Çπ' + Math.round(amount);
        }
    </script>
</body>
</html>
