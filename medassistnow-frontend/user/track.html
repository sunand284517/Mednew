<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Orders - MedAssist Now</title>
    <link rel="stylesheet" href="../styles/dashboard-modern.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 10px;
            bottom: 10px;
            width: 3px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        
        .timeline-marker {
            position: absolute;
            left: -33px;
            width: 30px;
            height: 30px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(8, 145, 178, 0.3);
        }
        
        .timeline-marker.completed {
            background: var(--gradient-success);
        }
        
        .timeline-marker.active {
            animation: pulse 2s infinite;
        }
        
        .timeline-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .timeline-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .timeline-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .dashboard-header .header-content { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { justify-content: center; }
            .timeline { padding-left: 30px; }
            .timeline::before { left: 10px; }
            .timeline-marker { left: -25px; width: 24px; height: 24px; font-size: 0.8rem; }
            .data-table { font-size: 0.85rem; }
        }
        
        @media (max-width: 480px) {
            .dashboard-container { padding: 10px; }
            .section-card { padding: 15px; }
        }
    </style>
</head>
<body data-required-role="user">
    <script src="../js/config.js"></script>
    <script>
        (async function() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.replace('login.html'); return; }
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { localStorage.clear(); window.location.replace('login.html'); return; }
                const data = await response.json();
                const user = data.data.user;
                if (user.role !== 'user') {
                    alert('Access denied. User role required.');
                    localStorage.clear();
                    window.location.replace('login.html');
                    return;
                }
                localStorage.setItem('userCache', JSON.stringify(user));
            } catch (e) {
                console.error('Auth error:', e);
                localStorage.clear();
                window.location.replace('login.html');
            }
        })();
    </script>
    
    <div class="emergency-banner">
        <div class="container">
            <div class="banner-content">
                <i class="fas fa-ambulance"></i>
                <span>Need medicines urgently? We're available 24/7 for emergency deliveries!</span>
                <a href="search.html" class="emergency-btn">Emergency Request</a>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="header-content">
                <div class="user-welcome">
                    <h1><i class="fas fa-map-marked-alt"></i> Track Orders</h1>
                    <p>Real-time tracking for all your deliveries</p>
                </div>
                <div class="header-actions">
                    <a href="dashboard.html" class="icon-btn"><i class="fas fa-home"></i></a>
                    <a href="search.html" class="icon-btn"><i class="fas fa-search"></i></a>
                    <a href="cart.html" class="icon-btn"><i class="fas fa-shopping-cart"></i></a>
                    <a href="profile.html" class="profile-btn" id="headerInitials">U</a>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- Active Order Section -->
            <div class="section-card" style="margin-bottom: 30px;" id="activeOrderSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-shipping-fast"></i>
                        Active Delivery
                    </h2>
                    <span class="badge badge-info" style="font-size: 1rem; padding: 8px 16px;" id="activeOrderStatus">
                        <i class="fas fa-circle" style="animation: pulse 2s infinite;"></i> Loading...
                    </span>
                </div>
                
                <div id="activeOrderDetails">
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>Loading orders...</h3>
                        <p>Please wait while we fetch your active deliveries</p>
                    </div>
                </div>
            </div>

            <!-- Order History -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-history"></i>
                        Order History
                    </h2>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Items</th>
                                <th>Pharmacy</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="orderHistoryBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                                    <p style="margin-top: 10px; color: var(--text-secondary);">Loading order history...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/order.service.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let allOrders = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            Auth.requireAuth('login.html');
            
            const user = Auth.getUser();
            if (user) {
                const initials = (user.name || 'User').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('headerInitials').textContent = initials;
                loadUserOrders();
                initializeSocketIO(user);
            }
        });
        
        function initializeSocketIO(user) {
            try {
                socket = io(API_CONFIG.BASE_URL.replace('/api', ''), {
                    transports: ['websocket', 'polling']
                });
                
                socket.on('connect', () => {
                    console.log('ðŸ”Œ Connected to real-time updates');
                    // Join user-specific room for targeted updates
                    socket.emit('joinRoom', `user_${user._id || user.id}`);
                });
                
                // Listen for order status updates
                socket.on('orderStatusUpdate', (data) => {
                    console.log('ðŸ“¦ Order status update:', data);
                    Utils.showToast(`Order #${data.orderId?.slice(-6)} status: ${getStatusText(data.status)}`, 'info');
                    loadUserOrders(); // Refresh orders
                });
                
                socket.on('orderCreated', (data) => {
                    console.log('ðŸ†• New order created:', data);
                    loadUserOrders();
                });
                
                socket.on('disconnect', () => {
                    console.log('ðŸ”Œ Disconnected from real-time updates');
                });
            } catch (error) {
                console.error('Socket.IO error:', error);
            }
        }
        
        async function loadUserOrders() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_CONFIG.BASE_URL}/orders/my-orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allOrders = data.data || [];
                    console.log('Loaded orders:', allOrders);
                    displayActiveOrder(allOrders);
                    displayOrderHistory(allOrders);
                } else {
                    console.error('Failed to load orders:', response.status);
                    showNoOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNoOrders();
            }
        }
        
        function displayActiveOrder(orders) {
            const activeOrder = orders.find(o => ['pending', 'processing', 'in_transit', 'out_for_delivery'].includes(o.status));
            const container = document.getElementById('activeOrderDetails');
            const statusBadge = document.getElementById('activeOrderStatus');
            
            if (!activeOrder) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No Active Deliveries</h3>
                        <p>You don't have any orders in transit right now</p>
                        <a href="search.html" class="btn-primary" style="display: inline-block; margin-top: 15px;">
                            <i class="fas fa-search"></i> Order Medicines
                        </a>
                    </div>
                `;
                statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> No Active Orders';
                statusBadge.className = 'badge badge-secondary';
                return;
            }
            
            const statusText = getStatusText(activeOrder.status);
            statusBadge.innerHTML = `<i class="fas fa-circle" style="animation: pulse 2s infinite;"></i> ${statusText}`;
            statusBadge.className = `badge badge-${getStatusColor(activeOrder.status)}`;
            
            const orderDate = new Date(activeOrder.createdAt);
            const items = activeOrder.items?.map(i => i.medicine?.name || i.name).join(', ') || 'Medicines';
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">
                                Order #${activeOrder.orderNumber || activeOrder._id?.slice(-8).toUpperCase() || 'N/A'}
                            </div>
                            <div style="color: var(--text-secondary);">
                                <i class="fas fa-calendar"></i> Placed on ${orderDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${orderDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                Estimated Delivery
                            </div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color);">
                                <i class="fas fa-clock"></i> ${activeOrder.estimatedDelivery || 'Soon'}
                            </div>
                        </div>
                    </div>
                    
                    ${activeOrder.deliveryPartner ? `
                    <div style="display: flex; gap: 15px; align-items: center; padding: 15px; background: white; border-radius: 10px;">
                        <div style="width: 60px; height: 60px; background: var(--gradient-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 3px;">Delivery Partner: ${activeOrder.deliveryPartner.name || 'Assigned'}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                <i class="fas fa-phone"></i> ${activeOrder.deliveryPartner.phone || 'Contact via app'}
                            </div>
                        </div>
                        ${activeOrder.deliveryPartner.phone ? `
                        <a href="tel:${activeOrder.deliveryPartner.phone}" class="btn-primary" style="padding: 10px 20px;">
                            <i class="fas fa-phone"></i> Call
                        </a>` : ''}
                    </div>` : `
                    <div style="padding: 15px; background: white; border-radius: 10px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-clock"></i> Waiting for delivery partner assignment
                    </div>`}
                </div>
                
                ${generateTimeline(activeOrder)}
            `;
        }
        
        function generateTimeline(order) {
            const steps = [
                { key: 'placed', icon: 'check', title: 'Order Placed', desc: 'Your order has been successfully placed' },
                { key: 'confirmed', icon: 'check', title: 'Order Confirmed', desc: 'Pharmacy confirmed your order' },
                { key: 'packed', icon: 'check', title: 'Order Packed', desc: 'Your medicines are packed and ready' },
                { key: 'in_transit', icon: 'shipping-fast', title: 'Out for Delivery', desc: 'Delivery partner is on the way' },
                { key: 'delivered', icon: 'home', title: 'Delivered', desc: 'Order will be delivered to your address' }
            ];
            
            const statusOrder = ['pending', 'confirmed', 'processing', 'packed', 'in_transit', 'out_for_delivery', 'delivered'];
            const currentIndex = statusOrder.indexOf(order.status);
            
            let html = '<div class="timeline">';
            steps.forEach((step, index) => {
                const isCompleted = index <= currentIndex;
                const isActive = index === currentIndex && order.status !== 'delivered';
                const isPending = index > currentIndex;
                
                html += `
                    <div class="timeline-item">
                        <div class="timeline-marker ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}" ${isPending ? 'style="background: #e5e7eb;"' : ''}>
                            <i class="fas fa-${step.icon}"></i>
                        </div>
                        <div class="timeline-content" ${isActive ? 'style="border: 2px solid var(--primary-color);"' : ''} ${isPending ? 'style="opacity: 0.6;"' : ''}>
                            <div class="timeline-time">${order.timestamps?.[step.key] ? new Date(order.timestamps[step.key]).toLocaleString() : (isPending ? 'Pending' : 'Completed')}</div>
                            <div class="timeline-title">${step.title}</div>
                            <div class="timeline-desc">${step.desc}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        function displayOrderHistory(orders) {
            const tbody = document.getElementById('orderHistoryBody');
            
            // Show ALL orders in history (sorted by date)
            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-history" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p style="margin-top: 10px; color: var(--text-secondary);">No orders yet</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const items = order.items?.map(i => i.medicine?.name || i.name || 'Medicine').join(', ') || 'Medicines';
                const orderDate = new Date(order.createdAt);
                const pharmacyName = order.pharmacy?.name || 'HealthPlus Pharmacy';
                const amount = order.totalAmount || order.totalPrice || 0;
                
                return `
                    <tr>
                        <td><strong>#${order.orderNumber || order._id?.slice(-6).toUpperCase()}</strong></td>
                        <td>${items.length > 30 ? items.substring(0, 30) + '...' : items}</td>
                        <td>${pharmacyName}</td>
                        <td><strong>â‚¹${parseFloat(amount).toFixed(2)}</strong></td>
                        <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></td>
                        <td>${orderDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>
                            <button class="btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="viewOrderDetails('${order._id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function showNoOrders() {
            document.getElementById('activeOrderDetails').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3>No Orders Found</h3>
                    <p>Start ordering medicines to see them here</p>
                    <a href="search.html" class="btn-primary" style="display: inline-block; margin-top: 15px;">
                        <i class="fas fa-search"></i> Order Medicines
                    </a>
                </div>
            `;
            document.getElementById('activeOrderStatus').innerHTML = '<i class="fas fa-check-circle"></i> No Active Orders';
            document.getElementById('activeOrderStatus').className = 'badge badge-secondary';
            document.getElementById('orderHistoryBody').innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <p style="color: var(--text-secondary);">No order history</p>
                    </td>
                </tr>
            `;
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'processing': 'Processing',
                'packed': 'Packed',
                'in_transit': 'In Transit',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }
        
        function getStatusColor(status) {
            const colorMap = {
                'pending': 'warning',
                'confirmed': 'info',
                'processing': 'info',
                'packed': 'info',
                'in_transit': 'primary',
                'out_for_delivery': 'primary',
                'delivered': 'success',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colorMap[status] || 'secondary';
        }
        
        async function reorderItems(orderId) {
            Utils.showToast('Reorder feature coming soon!', 'info');
        }
        
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o._id === orderId);
            if (!order) {
                Utils.showToast('Order not found', 'error');
                return;
            }
            
            // Scroll to active order section and display this order
            const container = document.getElementById('activeOrderDetails');
            const statusBadge = document.getElementById('activeOrderStatus');
            
            const statusText = getStatusText(order.status);
            statusBadge.innerHTML = `<i class="fas fa-circle"></i> ${statusText}`;
            statusBadge.className = `badge badge-${getStatusColor(order.status)}`;
            
            const orderDate = new Date(order.createdAt);
            const items = order.items?.map(i => i.medicine?.name || i.name || 'Medicine').join(', ') || 'Medicines';
            const pharmacyName = order.pharmacy?.name || 'HealthPlus Pharmacy';
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 5px;">
                                Order #${order.orderNumber || order._id?.slice(-6).toUpperCase()}
                            </div>
                            <div style="color: var(--text-secondary);">
                                <i class="fas fa-calendar"></i> Placed on ${orderDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${orderDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                            </div>
                            <div style="margin-top: 10px; color: var(--text-secondary);">
                                <i class="fas fa-store"></i> ${pharmacyName}
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                Total Amount
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">
                                â‚¹${parseFloat(order.totalAmount || order.totalPrice || 0).toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">
                            <i class="fas fa-pills"></i> Items Ordered:
                        </div>
                        <div style="color: var(--text-secondary);">
                            ${order.items?.map(i => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                    <span>${i.medicine?.name || i.name || 'Medicine'}</span>
                                    <span>x${i.quantity}</span>
                                </div>
                            `).join('') || 'No items'}
                        </div>
                    </div>
                    
                    ${order.deliveryPartner ? `
                    <div style="display: flex; gap: 15px; align-items: center; padding: 15px; background: white; border-radius: 10px;">
                        <div style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 3px;">Delivery Partner: ${order.deliveryPartner.name || 'Assigned'}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                <i class="fas fa-phone"></i> ${order.deliveryPartner.phone || 'Contact via app'}
                            </div>
                        </div>
                    </div>` : ''}
                </div>
                
                ${generateTimeline(order)}
            `;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Auto-refresh orders every 30 seconds for real-time updates
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadUserOrders();
            }
        }, 30000);
    </script>
</body>
</html>
