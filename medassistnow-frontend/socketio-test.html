<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test - MedAssistNow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.connected {
            background: #10b981;
            color: white;
        }

        .status.disconnected {
            background: #ef4444;
            color: white;
        }

        .status.connecting {
            background: #f59e0b;
            color: white;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 15px;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            background: white;
        }

        .log-entry.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .timestamp {
            color: #6b7280;
            font-size: 11px;
            margin-right: 8px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå Socket.IO Real-Time Test</h1>

        <div class="grid">
            <!-- Connection Card -->
            <div class="card">
                <h2>Connection Status</h2>
                <div id="connectionStatus" class="status disconnected">
                    ‚ùå Disconnected
                </div>
                <p><strong>Socket ID:</strong> <span id="socketId">-</span></p>
                
                <div style="margin-top: 15px;">
                    <label>User ID:</label>
                    <input type="text" id="userId" placeholder="Enter User ID (e.g., USER123)">
                    
                    <label>Role:</label>
                    <input type="text" id="userRole" placeholder="user, pharmacy, admin, delivery">
                    
                    <button onclick="authenticate()">üîê Authenticate</button>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="messagesReceived">0</div>
                        <div class="stat-label">Messages Received</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="messagesSent">0</div>
                        <div class="stat-label">Messages Sent</div>
                    </div>
                </div>
            </div>

            <!-- Test Actions Card -->
            <div class="card">
                <h2>Test Actions</h2>
                <div class="button-group">
                    <button onclick="testOrderUpdate()">üì¶ Test Order Update</button>
                    <button onclick="testNotification()">üîî Test Notification</button>
                    <button onclick="testMedicineUpdate()">üíä Test Medicine Update</button>
                    <button onclick="testDeliveryUpdate()">üöö Test Delivery Update</button>
                    <button onclick="subscribeToChannel()">üì° Subscribe to Channel</button>
                    <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                </div>

                <div style="margin-top: 15px;">
                    <label>Custom Channel:</label>
                    <input type="text" id="customChannel" placeholder="e.g., test:channel">
                    <button onclick="subscribeToCustom()">Subscribe</button>
                </div>
            </div>
        </div>

        <!-- Event Log Card -->
        <div class="card">
            <h2>üìä Event Log (Real-time)</h2>
            <div id="eventLog" class="log"></div>
        </div>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        let socket;
        let messagesReceived = 0;
        let messagesSent = 0;

        // Initialize Socket.IO connection
        function initSocket() {
            socket = io('http://localhost:3000', {
                transports: ['websocket', 'polling']
            });

            // Connection events
            socket.on('connect', () => {
                updateConnectionStatus('connected', '‚úÖ Connected');
                document.getElementById('socketId').textContent = socket.id;
                addLog('success', 'Connected to Socket.IO server');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('disconnected', '‚ùå Disconnected');
                addLog('error', 'Disconnected from server');
            });

            socket.on('connect_error', (error) => {
                updateConnectionStatus('disconnected', '‚ùå Connection Error');
                addLog('error', `Connection error: ${error.message}`);
            });

            // Authentication response
            socket.on('authenticated', (data) => {
                addLog('success', `Authenticated as ${data.userId}`);
            });

            // Order updates
            socket.on('order:update', (data) => {
                messagesReceived++;
                updateStats();
                addLog('info', `Order Update: ${JSON.stringify(data, null, 2)}`);
            });

            // Notifications
            socket.on('notification', (data) => {
                messagesReceived++;
                updateStats();
                addLog('info', `Notification: ${data.title} - ${data.message}`);
                showBrowserNotification(data.title, data.message);
            });

            // Medicine updates
            socket.on('medicine:update', (data) => {
                messagesReceived++;
                updateStats();
                addLog('info', `Medicine Update: ${JSON.stringify(data, null, 2)}`);
            });

            // Delivery updates
            socket.on('delivery:update', (data) => {
                messagesReceived++;
                updateStats();
                addLog('info', `Delivery Update: ${JSON.stringify(data, null, 2)}`);
            });

            // New orders (for pharmacy)
            socket.on('new:order', (data) => {
                messagesReceived++;
                updateStats();
                addLog('success', `üÜï New Order Received: ${JSON.stringify(data, null, 2)}`);
            });

            // User events
            socket.on('user:event', (data) => {
                messagesReceived++;
                updateStats();
                addLog('info', `User Event: ${JSON.stringify(data, null, 2)}`);
            });

            // Subscription confirmations
            socket.on('subscribed', (data) => {
                addLog('success', `‚úÖ Subscribed to: ${data.channel}`);
            });

            socket.on('unsubscribed', (data) => {
                addLog('info', `üì¥ Unsubscribed from: ${data.channel}`);
            });
        }

        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${status}`;
            statusEl.textContent = text;
        }

        function updateStats() {
            document.getElementById('messagesReceived').textContent = messagesReceived;
            document.getElementById('messagesSent').textContent = messagesSent;
        }

        function authenticate() {
            const userId = document.getElementById('userId').value || 'USER123';
            const role = document.getElementById('userRole').value || 'user';
            
            socket.emit('authenticate', { userId, role });
            messagesSent++;
            updateStats();
            addLog('info', `Authenticating as ${userId} (${role})`);
        }

        function testOrderUpdate() {
            fetch('http://localhost:3000/api/pubsub/broadcast/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderId: 'ORD' + Date.now(),
                    status: 'processing',
                    details: { items: 3, total: 1500 }
                })
            });
            messagesSent++;
            updateStats();
            addLog('success', 'Sent order update request');
        }

        function testNotification() {
            const userId = document.getElementById('userId').value || 'USER123';
            fetch('http://localhost:3000/api/queue/notification/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId,
                    title: 'Test Notification',
                    message: 'This is a real-time notification test!',
                    type: 'in_app'
                })
            });
            messagesSent++;
            updateStats();
            addLog('success', 'Sent notification request');
        }

        function testMedicineUpdate() {
            fetch('http://localhost:3000/api/pubsub/broadcast/medicine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    medicineId: 'MED001',
                    pharmacyId: 'PHARM001',
                    stock: Math.floor(Math.random() * 100),
                    action: 'stock_update'
                })
            });
            messagesSent++;
            updateStats();
            addLog('success', 'Sent medicine update');
        }

        function testDeliveryUpdate() {
            fetch('http://localhost:3000/api/pubsub/broadcast/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderId: 'ORD123',
                    status: 'out_for_delivery',
                    location: { lat: 12.9716, lng: 77.5946 }
                })
            });
            messagesSent++;
            updateStats();
            addLog('success', 'Sent delivery update');
        }

        function subscribeToChannel() {
            socket.emit('subscribe', 'order:updates');
            addLog('info', 'Subscribing to order:updates channel');
        }

        function subscribeToCustom() {
            const channel = document.getElementById('customChannel').value;
            if (channel) {
                socket.emit('subscribe', channel);
                addLog('info', `Subscribing to ${channel}`);
            }
        }

        function addLog(type, message) {
            const log = document.getElementById('eventLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">${time}</span>${message}`;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 50 logs
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        function clearLogs() {
            document.getElementById('eventLog').innerHTML = '';
            addLog('info', 'Logs cleared');
        }

        function showBrowserNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/assets/icons/notification.png'
                });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }

        // Request notification permission on load
        if ('Notification' in window) {
            Notification.requestPermission();
        }

        // Initialize connection on page load
        window.onload = () => {
            initSocket();
            addLog('info', 'Socket.IO test page loaded');
            addLog('info', 'Connecting to ws://localhost:3000');
        };
    </script>
</body>
</html>
